# API 访问日志功能说明

## 功能概述

本项目实现了全面的API访问日志功能，包括访问日志和错误日志的分离、按日期自动分割日志文件、结构化日志格式等特性，旨在提供完整、准确、易用的日志记录功能，便于后续日志分析和问题排查。

## 日志类型

### 1. 访问日志

记录所有API请求的详细信息，包括：
- 请求时间
- 客户端IP
- 请求方法
- 请求URL
- 请求参数
- 响应状态码
- 响应时间
- 请求体（仅在非生产环境记录）

### 2. 错误日志

记录API请求过程中发生的所有错误信息，包括：
- 错误时间
- 错误类型
- 错误堆栈
- 请求上下文
- 错误详情

## 日志存储

### 1. 日志文件路径

日志文件存储在项目根目录下的 `logs/` 文件夹中，具体文件包括：

| 日志类型 | 文件名格式 | 保留策略 |
|---------|------------|---------|
| 错误日志 | error-YYYY-MM-DD.log | 保留14天，每天一个文件 |
| 访问日志 | access-YYYY-MM-DD.log | 保留30天，每天一个文件 |
| 综合日志 | combined-YYYY-MM-DD.log | 保留30天，每天一个文件 |
| 异常日志 | exceptions-YYYY-MM-DD.log | 保留14天，每天一个文件 |
| 拒绝日志 | rejections-YYYY-MM-DD.log | 保留14天，每天一个文件 |

### 2. 日志文件轮转策略

- **按日期自动分割**：每天生成一个新的日志文件
- **文件压缩**：旧日志文件会自动压缩为zip格式
- **文件大小限制**：单个日志文件最大大小限制
  - 错误日志：20MB
  - 访问日志：50MB
  - 综合日志：100MB
- **文件保留期限**：超过保留期限的日志文件会自动删除

## 日志格式

### 1. 结构化日志格式

日志内容采用JSON结构化格式，便于后续日志分析和处理。示例：

```json
{
  "level": "info",
  "message": "API Request Completed",
  "timestamp": "2025-12-16 14:30:45",
  "metadata": {
    "requestId": "abc123xyz456",
    "method": "GET",
    "url": "/api/v1/domains",
    "ip": "127.0.0.1",
    "statusCode": 200,
    "responseTime": 150,
    "contentLength": "1234"
  }
}
```

### 2. 控制台日志格式

控制台输出采用彩色格式化日志，便于开发调试。示例：

```
2025-12-16 14:30:45 [INFO] API Request Completed {"requestId":"abc123xyz456","method":"GET","url":"/api/v1/domains","ip":"127.0.0.1","statusCode":200,"responseTime":150,"contentLength":"1234"}
```

## 配置说明

### 1. 环境变量配置

| 环境变量 | 描述 | 默认值 |
|---------|------|--------|
| LOG_LEVEL | 日志记录级别（debug/info/warn/error） | info |
| LOG_FORMAT | 日志格式（combined/json/simple） | combined |
| NODE_ENV | 运行环境（development/production） | development |

### 2. 代码配置

日志功能的核心配置位于 `src/middleware/logger.ts` 文件中，主要包括：

- 日志记录器的创建和配置
- 日志格式的定义
- 日志文件的存储路径和轮转策略
- 日志中间件的实现

## 使用说明

### 1. 自动日志记录

API请求日志会自动记录，无需额外配置。日志中间件已在 `app.ts` 中注册，会自动拦截所有API请求并记录日志。

### 2. 手动日志记录

在代码中可以通过引入 `logger` 对象手动记录日志，支持不同级别的日志记录：

```typescript
import { logger } from './middleware/logger';

// 记录debug级别日志
logger.debug('Debug message', { key: 'value' });

// 记录info级别日志
logger.info('Info message', { key: 'value' });

// 记录warn级别日志
logger.warn('Warn message', { key: 'value' });

// 记录error级别日志
logger.error('Error message', { key: 'value', error: new Error('Something went wrong') });
```

### 3. 日志查询和分析

可以使用各种日志分析工具（如ELK Stack、Splunk等）对日志文件进行查询和分析。由于日志采用结构化JSON格式，便于进行各种统计和分析操作。

## 性能与可靠性

1. **异步日志写入**：采用异步方式写入日志，不会阻塞主程序的执行
2. **异常处理机制**：实现了日志写入的异常处理，防止因日志问题导致主程序异常
3. **日志轮转策略**：通过合理的日志轮转和清理策略，避免磁盘空间耗尽
4. **生产环境优化**：在生产环境下自动禁用请求体日志记录，减少日志体积

## 最佳实践

1. **合理设置日志级别**：在生产环境下建议将日志级别设置为 `warn` 或 `error`，减少日志量
2. **定期清理日志**：虽然系统会自动清理过期日志，但建议定期检查日志目录，确保磁盘空间充足
3. **使用日志分析工具**：建议使用专业的日志分析工具对日志进行查询和分析，提高问题排查效率
4. **保护敏感信息**：日志中包含请求体等敏感信息，建议在生产环境下严格控制日志访问权限

## 常见问题

### 1. 日志文件没有生成

- 检查日志目录是否存在，权限是否正确
- 检查日志级别配置是否正确
- 检查应用是否有写入文件的权限

### 2. 日志文件过大

- 可以调整 `maxSize` 参数，减小单个日志文件的大小
- 可以调整 `maxFiles` 参数，缩短日志文件的保留期限
- 可以调整日志级别，减少日志量

### 3. 日志中包含敏感信息

- 生产环境下，系统会自动禁用请求体日志记录
- 可以在代码中手动过滤敏感信息
- 建议定期检查日志内容，确保没有敏感信息泄露

## 版本更新日志

### v1.0.0

- 实现了访问日志和错误日志的分离
- 实现了按日期自动分割日志文件的功能
- 采用了结构化JSON格式记录日志
- 实现了日志文件的轮转和清理策略
- 实现了日志写入的异常处理机制

## 联系方式

如有任何问题或建议，请联系项目维护人员。